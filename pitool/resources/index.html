<div xmlns:t="http://twistedmatrix.com/ns/twisted.web.template/0.1">

  <div class="panel panel-default">
    <div class="panel-heading">System detail</div>
    <div class="panel-body">

      <div t:render="board" class="row">
        <div class="col-lg-4 text-center">
          <img><t:attr name="src"><t:slot name="image" /></t:attr></img>
        </div>
        <div class="col-lg-4">
          <dl class="dl-horizontal">
            <dt>Type</dt>
            <dd><t:slot name="brd_name" /></dd>
            <dt>Memory</dt>
            <dd><t:slot name="mem" />MB</dd>
          </dl>

        </div>
      </div>
    </div>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading">GPIO</div>
    <div class="panel-body" id="gpiolist">
    </div>
  </div>

  <script type="text/javascript">
  //<![CDATA[
    function setState(event, state) {
      var bcm_id = event.target.name.substring(5,7);
      if (state) {
        var s = 1;
      }
      else {
        var s = 0;
      }
      $.getJSON( "/api/gpio/set/"+bcm_id+"/"+s, function( data ) {
        
      });
    }

    function setMode(mode, id) {
      $.getJSON( "/api/gpio/mode/"+id+"/"+mode, function( data ) {
        console.log(data);
        var gpio = $("#gp"+id);
        console.log(gpio);
        gpio.html(gpioRow(data));
        $("input[type=\"checkbox\"]").bootstrapSwitch();
        $("input[type=\"checkbox\"]").on('switchChange.bootstrapSwitch', setState);
      });
      return false;
    };

    function dropdownButton(label, id, dropdown) {
      var dt = '<div class="btn-group">';
      dt += '<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">';
      dt += label +  '<span class="caret"></span> </button>';
      dt += '<ul class="dropdown-menu">';

      $.each( dropdown, function(i, val) {
          dt += '<li><a href="#" onclick="return setMode(\'' + val[0] + '\', ' + id + ')">' + val[1] + '</a></li>';
      });
      dt += '</ul></div>';
      return dt;
    };

    function gpioRow(val) {
      var bcid = val["bcm_id"];
      
      var doc = "<div class=\"col-lg-1\">";
      doc += "<strong>"+val["bcm_id"]+"</strong>";
      doc += "</div>";

      doc += "<div class=\"col-lg-2\">";
      doc += dropdownButton(val["mode"], bcid, [
        ['input', 'Input'],
        ['output', 'Output']
      ]);
      doc += "</div>";

      doc += "<div class=\"col-lg-2\">";
      if (val["mode"] == "Input") {
        var state = "";
        switch (val["state"]) {
          case 0:
            state = "Low";
            break;
          case 1:
            state = "High";
            break;
          default:
            state = "Undefined";
        }
        doc += "<strong>Status: </strong>" +state;
      }
      else if (val["mode"] == "Output") {
        if (val["state"] == 1) {
          doc += '<input type="checkbox" data-size="mini" name="state'+bcid+'" checked>';
        }
        else {
          doc += '<input type="checkbox" data-size="mini" name="state'+bcid+'">';
        }
      }
      doc += "</div>";

      return doc;
    };

    $.getJSON( "/api/gpio", function( data ) {
      var gpiolist = $("#gpiolist");

      $.each( data["pins"], function(i, val) {
        console.log(val);
        var doc="<div class=\"row gpio\" id=\"gp"+val["bcm_id"]+"\">";
        doc += gpioRow(val);
        doc += "</div>";
        $(doc).appendTo(gpiolist);
      });

      $("input[type=\"checkbox\"]").bootstrapSwitch();
      $("input[type=\"checkbox\"]").on('switchChange.bootstrapSwitch', setState);
    });
  //]]>
  </script>

</div>
